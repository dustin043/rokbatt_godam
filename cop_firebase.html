<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ROKBATT COP â€” ì§€íœ˜í†µì œ</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #060a06;
    --panel: #0b100b;
    --panel2: #0f160f;
    --border: #163016;
    --border2: #1e401e;
    --accent: #00ff41;
    --accent-dim: rgba(0,255,65,0.15);
    --accent-glow: rgba(0,255,65,0.4);
    --warn: #ffcc00;
    --danger: #ff3333;
    --text: #b8d4b8;
    --muted: #3a5a3a;
    --mono: 'Share Tech Mono', monospace;
    --sans: 'Noto Sans KR', sans-serif;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--mono);
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* HEADER */
  #header {
    display: flex;
    align-items: center;
    height: 48px;
    padding: 0 20px;
    background: var(--panel);
    border-bottom: 1px solid var(--border2);
    flex-shrink: 0;
    gap: 0;
  }
  .hdr-block {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0 20px;
    border-right: 1px solid var(--border2);
    height: 100%;
  }
  .hdr-block:first-child { padding-left: 0; }
  .hdr-logo {
    font-size: 15px;
    font-weight: 900;
    color: var(--accent);
    letter-spacing: 3px;
    text-shadow: 0 0 12px var(--accent-glow);
  }
  .hdr-sub { font-size: 10px; color: var(--muted); letter-spacing: 1px; }
  .hdr-label { font-size: 10px; color: var(--muted); }
  .hdr-value { font-size: 13px; color: var(--accent); }
  .hdr-value.warn { color: var(--warn); }
  #clock-utc { font-size: 16px; color: var(--accent); letter-spacing: 2px; }
  #clock-kst { font-size: 10px; color: var(--muted); margin-top: 1px; }
  #conn-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--danger); box-shadow: 0 0 6px var(--danger);
    flex-shrink: 0; animation: pulse 1.5s infinite;
  }
  #conn-dot.ok { background: var(--accent); box-shadow: 0 0 6px var(--accent-glow); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
  #conn-text { font-size: 11px; }
  #conn-text.ok { color: var(--accent); }
  #conn-text.err { color: var(--danger); }

  /* BODY */
  #body { display: flex; flex: 1; overflow: hidden; }

  /* LEFT PANEL */
  #left-panel {
    width: 260px;
    background: var(--panel);
    border-right: 1px solid var(--border2);
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    overflow: hidden;
  }
  .panel-hdr {
    padding: 10px 14px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .panel-title { font-size: 10px; letter-spacing: 2px; color: var(--muted); }
  .badge { font-size: 10px; padding: 2px 8px; border-radius: 2px; font-family: var(--mono); }
  .badge-green { background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(0,255,65,0.3); }

  #unit-list {
    flex: 1; overflow-y: auto;
    padding: 8px;
    display: flex; flex-direction: column; gap: 4px;
  }
  .unit-card {
    background: var(--panel2);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 10px 12px;
    cursor: pointer;
    transition: border-color 0.15s, background 0.15s;
  }
  .unit-card:hover { border-color: var(--accent); background: rgba(0,255,65,0.04); }
  .uc-top { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
  .uc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .uc-callsign { font-size: 13px; font-weight: bold; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .uc-status { font-size: 9px; padding: 1px 6px; border-radius: 2px; }
  .status-active { background: rgba(0,255,65,0.1); color: var(--accent); border: 1px solid rgba(0,255,65,0.3); }
  .status-stale  { background: rgba(255,204,0,0.1); color: var(--warn);   border: 1px solid rgba(255,204,0,0.3); }
  .status-offline{ background: rgba(255,51,51,0.1);  color: var(--danger); border: 1px solid rgba(255,51,51,0.3); }
  .uc-utm  { font-size: 10px; color: var(--warn); margin-bottom: 2px; }
  .uc-time { font-size: 10px; color: var(--muted); }
  .uc-nogps{ font-size: 10px; color: var(--muted); font-style: italic; }

  /* MAP */
  #map-wrap { flex: 1; position: relative; overflow: hidden; }
  #map { width: 100%; height: 100%; }
  #map-wrap::after {
    content: '';
    position: absolute; inset: 0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events: none; z-index: 500;
  }

  /* MAP CONTROLS */
  .map-ctrl-btn {
    position: absolute; z-index: 600;
    background: var(--panel); border: 1px solid var(--border2);
    color: var(--accent); font-family: var(--mono); font-size: 11px;
    padding: 6px 12px; cursor: pointer; border-radius: 2px; transition: all 0.15s;
  }
  .map-ctrl-btn:hover { background: var(--accent-dim); }
  #btn-fit   { top: 12px; right: 12px; }
  #btn-layer { top: 48px; right: 12px; }

  /* POPUP */
  .custom-popup .leaflet-popup-content-wrapper {
    background: var(--panel); border: 1px solid var(--border2);
    border-radius: 3px; box-shadow: 0 0 20px rgba(0,255,65,0.2);
    color: var(--text); font-family: var(--mono);
  }
  .custom-popup .leaflet-popup-tip { background: var(--border2); }
  .custom-popup .leaflet-popup-content { margin: 12px 16px; font-size: 12px; line-height: 1.8; }

  /* LEAFLET DARK */
  .leaflet-tile { filter: brightness(0.45) saturate(0.2) hue-rotate(100deg); }
  .leaflet-container { background: #060a06; }
  .leaflet-control-zoom a { background: var(--panel) !important; color: var(--accent) !important; border-color: var(--border2) !important; }

  /* MARKER */
  .unit-label {
    background: rgba(6,10,6,0.9); border: 1px solid;
    font-family: var(--mono); font-size: 11px;
    padding: 3px 8px; border-radius: 2px;
    white-space: nowrap; pointer-events: none;
  }

  /* EMPTY */
  #empty-state {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%);
    text-align: center; color: var(--muted); font-size: 12px;
    z-index: 400; pointer-events: none;
  }
  #empty-state .big { font-size: 32px; margin-bottom: 12px; opacity: 0.3; }

  /* BOTTOM BAR */
  #bottom-bar {
    height: 32px; background: var(--panel);
    border-top: 1px solid var(--border2);
    display: flex; align-items: center;
    padding: 0 16px; gap: 20px; flex-shrink: 0;
  }
  .bb-item { font-size: 10px; color: var(--muted); }
  .bb-item span { color: var(--text); }

  /* NO GPS */
  #no-gps-notice {
    display: none; position: absolute;
    bottom: 40px; left: 50%; transform: translateX(-50%);
    background: rgba(255,204,0,0.15); border: 1px solid var(--warn);
    color: var(--warn); font-size: 11px;
    padding: 6px 16px; border-radius: 2px; z-index: 700; white-space: nowrap;
  }

  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 2px; }
</style>
</head>
<body>

<div id="header">
  <div class="hdr-block">
    <div>
      <div class="hdr-logo">â—ˆ ROKBATT COP</div>
      <div class="hdr-sub">COMMAND OPERATIONS PICTURE</div>
    </div>
  </div>
  <div class="hdr-block">
    <div>
      <div id="clock-utc">--:--:--</div>
      <div id="clock-kst">KST --:--</div>
    </div>
    <div class="hdr-label">UTC</div>
  </div>
  <div class="hdr-block">
    <div class="hdr-label">ì ‘ì† ì¸ì›</div>
    <div class="hdr-value" id="hdr-total">0</div>
  </div>
  <div class="hdr-block">
    <div class="hdr-label">GPS ìˆ˜ì‹ </div>
    <div class="hdr-value" id="hdr-gps">0</div>
  </div>
  <div class="hdr-block">
    <div class="hdr-label">GPS ëŒ€ê¸°</div>
    <div class="hdr-value warn" id="hdr-waiting">0</div>
  </div>
  <div class="hdr-block" style="margin-left:auto;border-right:none;border-left:1px solid var(--border2)">
    <div id="conn-dot"></div>
    <div id="conn-text" class="err">Firebase ì—°ê²° ì¤‘...</div>
  </div>
</div>

<div id="body">
  <div id="left-panel">
    <div class="panel-hdr">
      <span class="panel-title">// ì‘ì „ ì¸ì› í˜„í™©</span>
      <span class="badge badge-green" id="panel-count">0ëª…</span>
    </div>
    <div id="unit-list">
      <div id="list-empty" style="padding:20px 12px;font-size:11px;color:var(--muted);text-align:center;line-height:1.8">
        ëŒ€ê¸° ì¤‘...<br><br>
        ì¸ì› ê³µìœ  ë§í¬:<br>
        <span style="color:var(--accent);font-size:10px" id="field-link">field.html</span>
      </div>
    </div>
  </div>

  <div id="map-wrap">
    <div id="map"></div>
    <div id="empty-state">
      <div class="big">ğŸ“¡</div>
      <div>ì‘ì „ ì¸ì› ì ‘ì† ëŒ€ê¸° ì¤‘</div>
    </div>
    <button class="map-ctrl-btn" id="btn-fit" onclick="fitAll()">ì „ì²´ë³´ê¸°</button>
    <button class="map-ctrl-btn" id="btn-layer" onclick="toggleLayer()">ìœ„ì„±ì§€ë„</button>
    <div id="no-gps-notice">âš  GPS ë¯¸ìˆ˜ì‹  ì¸ì›ì´ ìˆìŠµë‹ˆë‹¤</div>
  </div>
</div>

<div id="bottom-bar">
  <div class="bb-item">AO: <span>SOUTH LEBANON / TYRE SECTOR</span></div>
  <div class="bb-item">ì¢Œí‘œê³„: <span>UTM-N ZONE 36</span></div>
  <div class="bb-item">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update">-</span></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBM86vLLG01b6nF2Q5RNg4YA8kn19KsLF4",
  authDomain: "rokbattgodam.firebaseapp.com",
  databaseURL: "https://rokbattgodam-default-rtdb.firebaseio.com",
  projectId: "rokbattgodam",
  storageBucket: "rokbattgodam.firebasestorage.app",
  messagingSenderId: "1031351457270",
  appId: "1:1031351457270:web:a9f17aa937b055e039e3d7",
  measurementId: "G-70H0W8QJ6P"
};

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CENTER = [33.2704, 35.2038];
const map = L.map('map', { center: CENTER, zoom: 13, zoomControl: true, attributionControl: false });

const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 });
const satLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19 });
osmLayer.addTo(map);
let isSat = false;

window.toggleLayer = () => {
  if (isSat) { map.removeLayer(satLayer); osmLayer.addTo(map); document.getElementById('btn-layer').textContent = 'ìœ„ì„±ì§€ë„'; }
  else        { map.removeLayer(osmLayer); satLayer.addTo(map); document.getElementById('btn-layer').textContent = 'ì¼ë°˜ì§€ë„'; }
  isSat = !isSat;
};

window.fitAll = () => {
  const pts = Object.values(trackers).filter(t => t.lat).map(t => [t.lat, t.lng]);
  if (!pts.length) { map.setView(CENTER, 13); return; }
  if (pts.length === 1) { map.setView(pts[0], 16); return; }
  map.fitBounds(L.latLngBounds(pts), { padding: [40, 40] });
};

// â”€â”€ UTM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toUTM(lat, lng) {
  const zone = Math.floor((lng+180)/6)+1;
  const band = lat >= 0 ? 'N' : 'S';
  const a=6378137,f=1/298.257223563,b=a*(1-f),e2=1-(b*b)/(a*a),k0=0.9996;
  const lng0=((zone-1)*6-180+3)*Math.PI/180;
  const latR=lat*Math.PI/180,lngR=lng*Math.PI/180;
  const N=a/Math.sqrt(1-e2*Math.sin(latR)**2);
  const T=Math.tan(latR)**2,C=(e2/(1-e2))*Math.cos(latR)**2,A2=Math.cos(latR)*(lngR-lng0);
  const e4=e2*e2,e6=e4*e2;
  const M=a*((1-e2/4-3*e4/64-5*e6/256)*latR-(3*e2/8+3*e4/32+45*e6/1024)*Math.sin(2*latR)+(15*e4/256+45*e6/1024)*Math.sin(4*latR)-(35*e6/3072)*Math.sin(6*latR));
  let E=k0*N*(A2+(1-T+C)*A2**3/6+(5-18*T+T*T+72*C)*A2**5/120)+500000;
  let Nn=k0*(M+N*Math.tan(latR)*(A2**2/2+(5-T+9*C+4*C*C)*A2**4/24+(61-58*T+T*T+600*C)*A2**6/720));
  if(lat<0) Nn+=10000000;
  return `${zone}${band} ${Math.round(E)} ${Math.round(Nn)}`;
}

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COLORS = ['#00ff41','#ffcc00','#00aaff','#ff6b35','#ff69b4','#7fff00','#ff4444','#00ffcc','#ffaa00','#aa00ff'];
const trackers = {}, markers = {}, colorMap = {};
let colorIdx = 0;
function getColor(id) { if (!colorMap[id]) colorMap[id] = COLORS[colorIdx++ % COLORS.length]; return colorMap[id]; }

// â”€â”€ FIREBASE LISTENER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const trackersRef = ref(db, 'trackers');

onValue(trackersRef, (snapshot) => {
  // ì—°ê²° ì„±ê³µ
  document.getElementById('conn-dot').className = 'ok';
  const t = document.getElementById('conn-text');
  t.textContent = 'Firebase ì—°ê²°ë¨'; t.className = 'ok';

  const data = snapshot.val() || {};
  const now = Date.now();

  // ì—†ì–´ì§„ ì¸ì› ì œê±° (15ë¶„ ì´ìƒ ì—…ë°ì´íŠ¸ ì—†ìœ¼ë©´)
  Object.keys(trackers).forEach(id => {
    if (!data[id]) {
      if (markers[id]) { markers[id].remove(); delete markers[id]; }
      delete trackers[id];
    }
  });

  // ì—…ë°ì´íŠ¸
  Object.entries(data).forEach(([id, d]) => {
    trackers[id] = d;
    if (d.lat) updateMarker(id, d);
  });

  const list = Object.values(data);
  updatePanel(list, now);
  updateHeader(list);
  updateLastTime();

  const noGps = list.filter(t => !t.lat).length;
  document.getElementById('no-gps-notice').style.display = noGps > 0 ? 'block' : 'none';
  document.getElementById('empty-state').style.display = list.length === 0 ? 'flex' : 'none';

}, (error) => {
  document.getElementById('conn-dot').className = '';
  const t = document.getElementById('conn-text');
  t.textContent = 'ì—°ê²° ì˜¤ë¥˜'; t.className = 'err';
  console.error(error);
});

// â”€â”€ MARKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateMarker(id, t) {
  const color = getColor(id);
  const icon = L.divIcon({
    className: '',
    html: `<div class="unit-label" style="border-color:${color};color:${color};box-shadow:0 0 10px ${color}55;text-shadow:0 0 8px ${color}">â—† ${t.callsign}</div>`,
    iconAnchor: [0, 12]
  });
  if (markers[id]) {
    markers[id].setLatLng([t.lat, t.lng]).setIcon(icon);
  } else {
    markers[id] = L.marker([t.lat, t.lng], { icon }).addTo(map)
      .bindPopup(buildPopup(id, t), { className: 'custom-popup' });
  }
  if (markers[id].isPopupOpen()) markers[id].setPopupContent(buildPopup(id, t));
}

function buildPopup(id, t) {
  const color = getColor(id);
  const time = t.timestamp ? new Date(t.timestamp).toUTCString().slice(5,25)+' UTC' : '-';
  return `<div style="color:${color};font-size:13px;font-weight:bold;margin-bottom:6px">â—† ${t.callsign}</div>
          <div>UTM: <span style="color:${color}">${t.utm || '-'}</span></div>
          <div>ìœ„ë„: ${t.lat?.toFixed(5)}</div>
          <div>ê²½ë„: ${t.lng?.toFixed(5)}</div>
          <div style="color:#3a5a3a;font-size:10px;margin-top:4px">${time}</div>`;
}

// â”€â”€ PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updatePanel(list, now) {
  const ul = document.getElementById('unit-list');
  if (!list.length) {
    ul.innerHTML = `<div style="padding:20px 12px;font-size:11px;color:var(--muted);text-align:center;line-height:1.8">
      ëŒ€ê¸° ì¤‘...<br><br>ì¸ì› ê³µìœ  ë§í¬:<br>
      <span style="color:var(--accent);font-size:10px">field.html ì„ ì¸ì›ë“¤ì—ê²Œ ê³µìœ í•˜ì„¸ìš”</span></div>`;
    return;
  }
  ul.innerHTML = '';
  list.forEach(t => {
    const id = t.id;
    const color = getColor(id);
    const hasGps = !!t.lat;
    const stale = t.timestamp ? (now - t.timestamp) / 1000 : 999;
    const [statusText, statusClass] =
      !hasGps        ? ['ëŒ€ê¸°',   'status-offline'] :
      stale < 15     ? ['ìˆ˜ì‹ ì¤‘', 'status-active']  :
      stale < 60     ? ['ì§€ì—°',   'status-stale']   :
                       ['ëŠê¹€',   'status-offline'];
    const timeStr = t.timestamp ? new Date(t.timestamp).toUTCString().slice(17,25)+'Z' : '-';

    const card = document.createElement('div');
    card.className = 'unit-card';
    card.innerHTML = `
      <div class="uc-top">
        <div class="uc-dot" style="background:${color};box-shadow:0 0 6px ${color}88"></div>
        <div class="uc-callsign" style="color:${color}">${t.callsign}</div>
        <div class="uc-status ${statusClass}">${statusText}</div>
      </div>
      ${hasGps
        ? `<div class="uc-utm">â–¸ ${t.utm}</div><div class="uc-time">ìµœì¢…: ${timeStr}</div>`
        : `<div class="uc-nogps">GPS ìˆ˜ì‹  ëŒ€ê¸°ì¤‘...</div>`}`;
    if (hasGps) card.onclick = () => { map.setView([t.lat, t.lng], 16); markers[id]?.openPopup(); };
    ul.appendChild(card);
  });
}

function updateHeader(list) {
  const gps = list.filter(t => t.lat).length;
  document.getElementById('hdr-total').textContent   = list.length;
  document.getElementById('hdr-gps').textContent     = gps;
  document.getElementById('hdr-waiting').textContent = list.length - gps;
  document.getElementById('panel-count').textContent = `${list.length}ëª…`;
}

function updateLastTime() {
  const n = new Date();
  document.getElementById('last-update').textContent =
    `${String(n.getUTCHours()).padStart(2,'0')}:${String(n.getUTCMinutes()).padStart(2,'0')}:${String(n.getUTCSeconds()).padStart(2,'0')} UTC`;
}

// â”€â”€ CLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClock() {
  const n = new Date();
  document.getElementById('clock-utc').textContent =
    `${String(n.getUTCHours()).padStart(2,'0')}:${String(n.getUTCMinutes()).padStart(2,'0')}:${String(n.getUTCSeconds()).padStart(2,'0')}`;
  const kst = new Date(n.getTime()+9*3600000);
  document.getElementById('clock-kst').textContent =
    `KST ${String(kst.getUTCHours()).padStart(2,'0')}:${String(kst.getUTCMinutes()).padStart(2,'0')}`;
}
setInterval(updateClock, 1000);
updateClock();
</script>
</body>
</html>
